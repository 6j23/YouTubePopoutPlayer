// ==UserScript==
// @name        YouTube Popout Player
// @author      Ryan Thaut <rthaut@gmail.com> (http://ryanthaut.com)
// @description Provides a simple way to open any YouTube video in a popout window
// @version     2.1.3
// @namespace   https://github.com/rthaut/YouTubePopoutPlayer
// @updateURL   https://github.com/rthaut/YouTubePopoutPlayer/raw/master/dist/userscript/youtube_popout_player.user.min.js
// @downloadURL https://github.com/rthaut/YouTubePopoutPlayer/raw/master/dist/userscript/youtube_popout_player.user.min.js
// @include     http://*youtube.com/*
// @include     http://*youtube-nocookie.com/*
// @include     https://*youtube.com/*
// @include     https://*youtube-nocookie.com/*
// ==/UserScript==
/**
 * YouTube Popout Player - Provides a simple way to open any YouTube video in a popout window
 * @version v2.1.3
 * @link https://github.com/rthaut/YouTubePopoutPlayer
 * @license GPL-3.0
 */
!function(){"use strict";const t=(()=>{return class{constructor(){this.container=null,this.player=null,this.container=document.getElementById("movie_player")||document.getElementById("player"),this.container&&(this.player=this.container.getElementsByTagName("video")[0],this.player)}pause(){this.player&&this.player.pause()}remove(){this.container&&this.container.remove()}getWidth(){return this.player?this.player.clientWidth:null}getHeight(){return this.player?this.player.clientHeight:null}getTime(){return this.player?parseInt(this.player.currentTime,10):null}}})();(new((()=>{return class{constructor(){this.defaults={width:854,height:480,startThreshold:5}}getVideoIDFromPlayer(t){var e=this.getVideoIDFromURL(t.baseURI);return e}getVideoIDFromURL(t){var e=null,n=new RegExp(/(?:(?:v=)|(?:\/embed\/)|(?:\/youtu\.be\/))([^\?\&\/]{11})/).exec(t);return n&&n[1]&&(e=n[1]),e}getPlaylistIDFromURL(t){var e=null,n=new RegExp(/list=((?:WL|[^\?\&\/]+))/).exec(t);return n&&n[1]&&(e=n[1]),e}insertControls(){this.insertContextMenuEntry(),this.insertPlayerControlsButton()}insertContextMenuEntry(){var t=document.getElementsByClassName("ytp-contextmenu")[0];if(!t)return!1;var e=t.getElementsByClassName("ytp-panel")[0].getElementsByClassName("ytp-panel-menu")[0],n=document.getElementById("popout-player-context-menu-item");if(n)return!1;(n=document.createElement("div")).className="ytp-menuitem",n.setAttribute("aria-haspopup",!1),n.setAttribute("role","menuitem"),n.setAttribute("tabindex",0),n.id="popout-player-context-menu-item";var r=document.createElement("div");r.className="ytp-menuitem-label",r.innerText="Popout Player";var s=document.createElement("div");s.className="ytp-menuitem-content",n.appendChild(r),n.appendChild(s),n.addEventListener("click",function(){this.onClick()}.bind(this),!1),e.appendChild(n);var i=document.getElementsByClassName("ytp-contextmenu"),a=i[i.length-1],l=a.getElementsByClassName("ytp-panel")[0],o=l.getElementsByClassName("ytp-panel-menu")[0],u=a.offsetHeight+n.offsetHeight;a.style.height=u+"px",l.style.height=u+"px",o.style.height=u+"px"}insertPlayerControlsButton(){var t=document.getElementsByClassName("ytp-right-controls")[0];if(!t)return!1;var e=t.getElementsByClassName("ytp-fullscreen-button")[0];if(!e)return!1;var n=t.getElementsByClassName("ytp-popout-button")[0];if(n)return!1;var r="http://www.w3.org/2000/svg",s="http://www.w3.org/1999/xlink",i=document.createElementNS(r,"svg");i.setAttribute("width","100%"),i.setAttribute("height","100%"),i.setAttribute("viewBox","0 0 36 36"),i.setAttribute("version","1.1");var a=document.createElementNS(r,"path");a.id="ytp-svg-pop-01",a.setAttributeNS(null,"d","m 8,8 v 20 h 20 v -6 h -2 v 4 H 10 V 10 h 4 V 8 Z"),a.setAttributeNS(null,"class","ytp-svg-fill");var l=document.createElementNS(r,"path");l.id="ytp-svg-pop-02",l.setAttributeNS(null,"d","M 28,8 H 18 l 3,3 -7,8 3,3 8,-7 3,3 z"),l.setAttributeNS(null,"class","ytp-svg-fill");var o=document.createElementNS(r,"use");o.setAttributeNS(null,"class","ytp-svg-shadow"),o.setAttributeNS(s,"href","#"+a.id);var u=document.createElementNS(r,"use");u.setAttributeNS(null,"class","ytp-svg-shadow"),u.setAttributeNS(s,"href","#"+l.id),i.appendChild(o),i.appendChild(a),i.appendChild(u),i.appendChild(l),(n=document.createElement("button")).className=["ytp-popout-button","ytp-button"].join(" "),n.id="popout-player-control-button",n.setAttribute("title","Popout Player"),n.appendChild(i),n.addEventListener("click",function(){this.onClick()}.bind(this),!1),t.insertBefore(n,e)}onClick(e){var n=new t;n.pause();var r=this.getVideoIDFromPlayer(n.player)||this.getVideoIDFromURL(window.location.href),s=this.getPlaylistIDFromURL(window.location.href),i=n.getTime()||0;i<=this.defaults.startThreshold&&(i=0);var a={};null!=s&&(a.list=s),a.start=i,a.autoplay=1;var l={width:n.getWidth()||this.defaults.width,height:n.getHeight()||this.defaults.height,scrollbars:"no",toolbar:"no"};n.pause(),this.popoutPlayer(r,a,l)}popoutPlayer(t,e,n){var r="https://www.youtube.com/embed/"+t+"?";if(void 0!==e){for(var s in e)r+=s+"="+e[s]+"&";r=r.replace(/\&$/,"")}var i="";if(void 0!==n){for(var a in n)i+=a+"="+n[a]+",";i=i.replace(/\,$/,"")}window.open(r,t,i)}watchPageChange(){var t=this;new MutationObserver(function(e){e.forEach(function(e){if(null!=e.addedNodes)for(var n=0;n<e.addedNodes.length;n++)switch(e.addedNodes[n].className){case"ytp-popup ytp-contextmenu":t.insertContextMenuEntry();break;case"ytp-right-controls":t.insertPlayerControlsButton()}})}).observe(document.body,{childList:!0,subtree:!0})}run(){this.insertControls(),this.watchPageChange()}}})())).run()}();